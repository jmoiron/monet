<form method="POST" action="" class="posts-form">
    {{if .post.ID}}<input type="hidden" name="id" id="id" value="{{.post.ID}}" />{{end}}
    <div>
        <input type="text" name="title" id="title" class="post-title-input js-clear-default"
            value="{{if .post.Title}}{{ .post.Title}}{{else}}Type a new title...{{end}}" data-default="Type a new title...">
        <div class="shrink-grow-buttons">
          <i class="fa-solid fa-down-left-and-up-right-to-center shrink"></i>
          <i class="fa-solid fa-up-right-and-down-left-from-center grow"></i>
        </div>
    <div>
        <textarea class="split-content-input js-clear-default" name="content" id="content" spellcheck="true" data-default="Type some new content...">{{
            if .post.Content}}{{.post.Content}}{{else}}Type some new content...{{end
        }}</textarea>
    </div>
    <div class="extras">
        <div>
            <label for="slug">slug</label>
            <input type="text" name="slug" id="slug" class="post-slug-input" value="{{.post.Slug}}">
        </div>
        <div>
            <label for="created">created at</label>
            <input type="timestamp" name="created" id="created" value="{{.post.CreatedAt}}">
            <span class="date" style="float:none;">{{.post.CreatedAt | naturalTime}}</span>
        </div>
        <div>
            <label for="ogDescription">OG Description</label>
            <input type="text" name="ogDescription" id="ogDescription" value="{{.post.OgDescription}}">
        </div>
        <div>
            <label for="ogImage">OG Image (URL)</label>
            <input type="text" name="ogImage" id="ogImage" value="{{.post.OgImage}}">
        </div>
        <div>
            Updated At: <span class="date" style="float:none;">{{.post.UpdatedAt | naturalTime}}</span>
        </div>
        <div>
            Published At: <span class="date" style="float:none;">{{.post.PublishedAt | naturalTime}}</span>
        </div>

        {{if .post.ID}}
        <div class="attached-files-section">
            <label>Attached Files</label>

            <!-- Existing attached files -->
            {{if .attachedFiles}}
            <div class="attached-files-list">
                {{range $file := .attachedFiles}}
                <div class="file-item" data-upload-id="{{$file.ID}}">
                    <div class="file-info">
                        <a href="{{$file.URL}}" target="_blank" class="filename">{{$file.Filename}}</a>
                        <span class="file-meta">{{$file.Size | humanizeBytes}} • {{$file.CreatedAt | naturalTime}}</span>
                    </div>
                    <a class="del" href="#" onclick="deleteAttachedFile({{$file.ID}}); return false;">
                        <i class="fa-solid fa-circle-xmark"></i>
                    </a>
                </div>
                {{end}}
            </div>
            {{end}}

            <!-- Upload zone using plugin -->
            <div id="post-upload-area"></div>
        </div>
        {{end}}
    </div>
    <div class="button-group">
      <div class="published">
          <input type="hidden" value="{{.post.Published}}" name="published" id="published">
          <a class="published-toggle-button published-{{.post.Published}}">Published
              <i class="icon {{if gt .post.Published 0}}icon-check{{else}}icon-remove{{end}}"></i>
          </a>
      </div>
      <div class="buttons">
          {{if .post.ID}}{{if .debug}}<a class="debug-autosave-button" title="Force autosave">+</a>{{end}}<a class="autosave-button{{if eq .numAutosaves 0}} inactive{{end}}"><i class="fa-solid fa-code-branch"></i> Autosaves</a>{{end}}
          <input class="more-button" type="button" value="More">
          <input class="save-button" type="submit" value="Save">
      </div>
      <div class="clear"></div>
    </div>
</form>

{{if .post.ID}}
<!-- Autosave Viewer Modal -->
<div id="autosave-modal" class="autosave-modal">
    <div class="autosave-modal-content">
        <div class="autosave-modal-header">
            <h3>Autosaved Versions</h3>
            <button class="autosave-modal-close">&times;</button>
        </div>
        <div class="autosave-modal-body">
            <div id="autosave-list" class="autosave-list">
                <p>Loading autosaves...</p>
            </div>
            <div id="autosave-diff" class="autosave-diff" style="display: none;">
                <div class="autosave-diff-header">
                    <button id="back-to-list">&larr; Back to list</button>
                    <button id="restore-autosave" class="restore-button">Restore this version</button>
                </div>
                <div id="diff-content"></div>
            </div>
        </div>
    </div>
</div>
{{end}}

<script src="/static/js/wasm_exec_1.23.4.js"></script>
<script src="/static/js/goldmark.js"></script>
<script>$(() => {$("#content").livePreview();});</script>

{{if .post.ID}}
<script src="/static/upload.js"></script>
<script>
// File upload functionality for blog posts using the upload plugin
const postId = {{.post.ID}};

$(() => {
    // Initialize upload plugin
    $('#post-upload-area').upload({
        url: `/admin/posts/${postId}/upload`,
        text: {
            dropZone: 'Drag & drop files here or click to upload',
            hint: 'Upload files to attach to this blog post'
        },
        onSuccess: function(response, filename) {
            console.log('Successfully uploaded:', filename);
            // Add the new file to the existing files list
            addFileToList(response);
        },
        onError: function(error, filename) {
            console.error('Failed to upload:', filename, error);
        },
        onComplete: function(successful, failed) {
            if (successful > 0) {
                console.log(`${successful} files uploaded successfully`);
            }
        }
    });
});

// Add uploaded file to the existing files list
function addFileToList(fileData) {
    let filesList = document.querySelector('.attached-files-list');

    // Create the files list if it doesn't exist
    if (!filesList) {
        filesList = document.createElement('div');
        filesList.className = 'attached-files-list';
        document.querySelector('.attached-files-section').insertBefore(
            filesList,
            document.querySelector('#post-upload-area')
        );
    }

    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.setAttribute('data-upload-id', fileData.id);

    fileItem.innerHTML = `
        <div class="file-info">
            <a href="${fileData.url}" target="_blank" class="filename">${fileData.filename}</a>
            <span class="file-meta">${$.fn.upload.humanizeBytes(fileData.size)} • just now</span>
        </div>
        <a class="del" href="#" onclick="deleteAttachedFile(${fileData.id}); return false;">
            <i class="fa-solid fa-circle-xmark"></i>
        </a>
    `;

    filesList.appendChild(fileItem);
}

// Delete attached file (keep existing functionality)
function deleteAttachedFile(uploadId) {
    fetch(`/admin/posts/${postId}/files/${uploadId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const fileItem = document.querySelector(`[data-upload-id="${uploadId}"]`);
            if (fileItem) fileItem.remove();
        } else {
            alert('Failed to delete file');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Failed to delete file');
    });
}

// Autosave functionality
$(() => {
    let contentChanged = false;
    let titleChanged = false;
    const autosaveInterval = 5 * 60 * 1000; // 5 minutes in milliseconds

    // Track content changes
    $('#content').on('input', () => {
        contentChanged = true;
    });

    $('#title').on('input', () => {
        titleChanged = true;
    });

    // Autosave function
    function performAutosave() {
        if (!contentChanged && !titleChanged) {
            return; // Nothing changed, skip autosave
        }

        const formData = new FormData();
        formData.append('content', $('#content').val());
        formData.append('title', $('#title').val());

        // Show autosaving indicator
        showAutosaveStatus('Autosaving...');

        fetch(`/admin/posts/${postId}/autosave`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                contentChanged = false;
                titleChanged = false;
                showAutosaveStatus('Autosaved', true);
                // Enable the autosave button if it was inactive
                $('.autosave-button').removeClass('inactive');
            } else {
                showAutosaveStatus('Autosave failed', false);
            }
        })
        .catch(error => {
            console.error('Autosave error:', error);
            showAutosaveStatus('Autosave failed', false);
        });
    }

    // Show autosave status message
    function showAutosaveStatus(message, success = null) {
        let statusEl = $('#autosave-status');

        if (statusEl.length === 0) {
            statusEl = $('<div id="autosave-status"></div>');
            $('.button-group').prepend(statusEl);
        }

        statusEl.text(message);
        statusEl.removeClass('success error');

        if (success === true) {
            statusEl.addClass('success');
            setTimeout(() => statusEl.fadeOut(), 2000);
        } else if (success === false) {
            statusEl.addClass('error');
        } else {
            statusEl.show();
        }
    }

    // Set up autosave interval
    setInterval(performAutosave, autosaveInterval);

    // Autosave viewer functionality
    let currentAutosaves = [];
    let selectedAutosave = null;

    // Open autosave modal (only if not inactive)
    $('.autosave-button').on('click', (e) => {
        e.preventDefault();
        if ($(e.currentTarget).hasClass('inactive')) return;
        loadAutosaves();
        $('#autosave-modal').show();
    });

    // Debug: force autosave button
    $('.debug-autosave-button').on('click', (e) => {
        e.preventDefault();
        contentChanged = true;
        performAutosave();
    });

    // Close modal
    $('.autosave-modal-close').on('click', () => {
        $('#autosave-modal').hide();
    });

    // Click outside modal to close
    $('#autosave-modal').on('click', (e) => {
        if (e.target.id === 'autosave-modal') {
            $('#autosave-modal').hide();
        }
    });

    // Load autosaves list
    function loadAutosaves() {
        $('#autosave-list').html('<p>Loading autosaves...</p>');
        $('#autosave-diff').hide();
        $('#autosave-list').show();

        fetch(`/admin/posts/${postId}/autosaves`)
            .then(response => response.json())
            .then(autosaves => {
                currentAutosaves = autosaves;
                if (autosaves.length === 0) {
                    $('#autosave-list').html('<p>No autosaves found.</p>');
                } else {
                    displayAutosaveList(autosaves);
                }
            })
            .catch(error => {
                console.error('Failed to load autosaves:', error);
                $('#autosave-list').html('<p>Failed to load autosaves.</p>');
            });
    }

    // Display list of autosaves
    function displayAutosaveList(autosaves) {
        let html = '<div class="autosave-items">';
        autosaves.forEach(autosave => {
            const date = new Date(autosave.created_at);
            const timeAgo = getTimeAgo(date);
            html += `
                <div class="autosave-item" data-autosave-id="${autosave.id}">
                    <div class="autosave-time">${timeAgo}</div>
                    <div class="autosave-preview">${escapeHtml(autosave.title || 'Untitled')}</div>
                    <button class="view-diff-btn" data-autosave-id="${autosave.id}">View Diff</button>
                </div>
            `;
        });
        html += '</div>';
        $('#autosave-list').html(html);

        // Attach click handlers
        $('.view-diff-btn').on('click', function() {
            const autosaveId = $(this).data('autosave-id');
            viewDiff(autosaveId);
        });
    }

    // View diff for a specific autosave
    function viewDiff(autosaveId) {
        const autosave = currentAutosaves.find(a => a.id === autosaveId);
        if (!autosave) return;

        selectedAutosave = autosave;
        const currentContent = $('#content').val();
        const autosaveContent = autosave.content;

        const diff = createDiff(currentContent, autosaveContent);
        $('#diff-content').html(diff);
        $('#autosave-list').hide();
        $('#autosave-diff').show();
    }

    // Back to list
    $('#back-to-list').on('click', () => {
        $('#autosave-diff').hide();
        $('#autosave-list').show();
        selectedAutosave = null;
    });

    // Restore autosave
    $('#restore-autosave').on('click', () => {
        if (!selectedAutosave) return;

        if (!confirm('Are you sure you want to restore this version? Your current unsaved changes will be lost.')) {
            return;
        }

        fetch(`/admin/posts/${postId}/restore/${selectedAutosave.id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to show the restored content
                location.reload();
            } else {
                alert('Failed to restore autosave');
            }
        })
        .catch(error => {
            console.error('Restore error:', error);
            alert('Failed to restore autosave');
        });
    });

    // Simple line-by-line diff
    function createDiff(current, autosaved) {
        const currentLines = current.split('\n');
        const autosaveLines = autosaved.split('\n');

        let html = '<div class="diff-view"><div class="diff-legend">';
        html += '<span class="diff-legend-item"><span class="diff-removed-marker"></span> Current Version</span>';
        html += '<span class="diff-legend-item"><span class="diff-added-marker"></span> Autosaved Version</span>';
        html += '</div><table class="diff-table">';

        const maxLines = Math.max(currentLines.length, autosaveLines.length);
        for (let i = 0; i < maxLines; i++) {
            const currentLine = currentLines[i] || '';
            const autosaveLine = autosaveLines[i] || '';

            if (currentLine === autosaveLine) {
                html += `<tr class="diff-unchanged">
                    <td class="diff-line-number">${i + 1}</td>
                    <td class="diff-line-content">${escapeHtml(currentLine) || '&nbsp;'}</td>
                </tr>`;
            } else {
                if (currentLine) {
                    html += `<tr class="diff-removed">
                        <td class="diff-line-number">${i + 1}</td>
                        <td class="diff-line-content">- ${escapeHtml(currentLine)}</td>
                    </tr>`;
                }
                if (autosaveLine) {
                    html += `<tr class="diff-added">
                        <td class="diff-line-number">${i + 1}</td>
                        <td class="diff-line-content">+ ${escapeHtml(autosaveLine)}</td>
                    </tr>`;
                }
            }
        }
        html += '</table></div>';
        return html;
    }

    // Helper functions
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);

        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + ' years ago';

        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + ' months ago';

        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + ' days ago';

        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + ' hours ago';

        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + ' minutes ago';

        return Math.floor(seconds) + ' seconds ago';
    }
});
</script>

<style>
.attached-files-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.attached-files-list {
    margin-bottom: 15px;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.file-item:last-child {
    border-bottom: none;
}

.file-info {
    flex: 1;
}

.filename {
    font-weight: 500;
    display: block;
    color: #0066cc;
    text-decoration: none;
}

.filename:hover {
    text-decoration: underline;
}

.file-meta {
    font-size: 0.85em;
    color: #666;
}

</style>
{{end}}